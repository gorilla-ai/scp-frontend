{"version":3,"sources":["../../../src/symbols/spot.js"],"names":["OPTION_DICT","ALIEN_ATTR","Spot","id","props","selected","selectedProps","_type","_selected","newProps","_","merge","_props","_selectedProps","mergeClass","_truncateLabels","get","className","chain","split","uniq","join","value","label","set","content","_layer","_createLayer","isEqual","currentProps","_updateLayer","_setLabel","_setSign","omit","concat","options","pick","divIcon","L","_icon","marker","latlng","icon","prevProps","nextProps","setLatLng","isNil","_setIcon","clearTimeout","setTimeout","setIcon","_addDrawClass","tooltip","_updateInfo","INFO_TYPE","TOOLTIP","popup","POPUP","item","_label","labelClass","rotation","spot","width","height","opacity","p","transform","camelCaseToDash","str","replace","toLowerCase","styleString","Object","keys","forEach","key","prototype","hasOwnProperty","call","has","html","iconAnchor","parseInt","iconSize","Marker"],"mappings":"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","sourcesContent":["import _ from 'lodash';\r\nimport cx from 'classnames';\r\nimport L from 'leaflet';\r\n\r\nimport Marker from './marker';\r\nimport { INFO_TYPE } from '../consts/dictionary';\r\n\r\n// const log = require('loglevel').getLogger('gis/symbols/spot');\r\n\r\nconst OPTION_DICT = [\r\n  'draggable', 'keyboard', 'title', 'zIndexOffset',\r\n  'opacity', 'riseOnHover', 'riseOffset', 'pane'\r\n];\r\n\r\nconst ALIEN_ATTR = [\r\n  'latlng', 'className', 'data', 'selectedProps', 'tooltip', 'popup',\r\n  'heatmap', 'type', 'selected', 'smoothFactor', 'noClip',\r\n  'patterns', 'directed', 'icon', 'label', 'radius', 'track', 'ts',\r\n  'cluster', 'group'\r\n];\r\n\r\n/**\r\n * A Spot symbol, inherits from class Marker.\r\n *\r\n * @see     Symbol and Marker\r\n * @link    https://git.gorilla-technology.com/gorilla/gis/blob/master/docs/symbol.md\r\n * @link    https://git.gorilla-technology.com/gorilla/gis/blob/master/docs/marker.md\r\n * @link    https://git.gorilla-technology.com/gorilla/gis/blob/master/docs/spot.md\r\n *\r\n * @class\r\n * @param {String}  id              The spot symbol id.\r\n * @param {Object}  props           The properties of the spot.\r\n * @param {Boolean} selected        The selected status.\r\n * @param {Boolean} selectedProps   Properties will apply when symbol is selected.\r\n */\r\nclass Spot extends Marker {\r\n  constructor(id, props, selected, selectedProps) {\r\n    super(id, props, selected, selectedProps);\r\n    this._type = 'spot';\r\n  }\r\n\r\n  /*\r\n   * Creates/Updates the leaflet marker instance, which icon is a dot.\r\n   *\r\n   * @param {Object}  props           The marker props.\r\n   * @param {Boolean} selected        Selected status.\r\n   * @param {Boolean} selectedProps   Props to apply when selected.\r\n   *\r\n   * @return {L.Marker}               The leaflet marker instance.\r\n   */\r\n  setLayer(props, selected = this._selected, selectedProps) {\r\n    const newProps = selected\r\n      ? _.merge({}, this._props, props, this._selectedProps, selectedProps)\r\n      : _.merge({}, this._props, props);\r\n\r\n    const mergeClass = cx(\r\n      'gis-spot',\r\n      'gis-divIcon',\r\n      {\r\n        'gis-truncated-labels': !!this._props._truncateLabels,\r\n        'gis-whole-label': _.get(this._props, '_truncateLabels.shownOnHover', true),\r\n        selected,\r\n        'js-top-layer': selected\r\n      },\r\n      props.className || '',\r\n      newProps.className || ''\r\n    );\r\n\r\n    const className = _.chain(mergeClass)\r\n      .split(' ')\r\n      .uniq()\r\n      .join(' ')\r\n      .value();\r\n\r\n    newProps.className = className;\r\n\r\n    // Labels may be shown only when selected\r\n    if (!selected && !props.label) {\r\n      _.set(newProps, 'label', { content: '', className: '' });\r\n    }\r\n\r\n    if (!this._layer) {\r\n      this._layer = this._createLayer(newProps);\r\n    } else if (this._layer && !_.isEqual(this.currentProps, newProps)) {\r\n      this._layer = this._updateLayer(this.currentProps, newProps);\r\n    }\r\n\r\n    return this._layer;\r\n  }\r\n\r\n  /*\r\n   * Creates Leaflet marker layer instance.\r\n   *\r\n   * @param {Object}  props   Spot props.\r\n   *\r\n   */\r\n  _createLayer(props) {\r\n    this._setLabel(props.label);\r\n    this._setSign({\r\n      ..._.omit(props, _.concat(ALIEN_ATTR, OPTION_DICT)),\r\n      className: props.className\r\n    });\r\n\r\n    const options = _.pick(props, OPTION_DICT);\r\n    const divIcon = L.divIcon(_.omit(this._icon, 'rotation'));\r\n\r\n    this._layer = L.marker(props.latlng, {\r\n      ...options,\r\n      icon: divIcon\r\n    });\r\n\r\n    return this._layer;\r\n  }\r\n\r\n  /*\r\n   * Updates the Leaflet marker layer instance.\r\n   *\r\n   * @param {Object}  prevProps   Original spot props.\r\n   * @param {Object}  nextProps   New spot props.\r\n   *\r\n   */\r\n  _updateLayer(prevProps, nextProps) {\r\n    if (!_.isEqual(prevProps, nextProps)) {\r\n      // Set the location\r\n      if (!_.isEqual(prevProps.latlng, nextProps.latlng)) {\r\n        this._layer.setLatLng(nextProps.latlng);\r\n      }\r\n\r\n      // Need to update label or not\r\n      if (!_.isNil(nextProps.label)) {\r\n        this._setLabel(nextProps.label);\r\n      }\r\n\r\n      // Update spot\r\n      if (!_.isNil(nextProps)) {\r\n        this._setSign({\r\n          ..._.omit(nextProps, _.concat(ALIEN_ATTR, OPTION_DICT)),\r\n          className: nextProps.className\r\n        });\r\n\r\n        // this._layer.setIcon(L.divIcon(this._icon))\r\n        if (this._setIcon) {\r\n          clearTimeout(this._setIcon);\r\n        }\r\n\r\n        this._setIcon = setTimeout(() => {\r\n          this._layer.setIcon(L.divIcon(_.omit(this._icon, 'rotation')));\r\n          this._addDrawClass();\r\n        }, 200);\r\n      }\r\n\r\n      if (this._props.tooltip && !_.isNil(nextProps.tooltip)) {\r\n        this._updateInfo(INFO_TYPE.TOOLTIP, prevProps.tooltip, nextProps.tooltip);\r\n      }\r\n\r\n      if (this._props.popup && !_.isNil(nextProps.popup)) {\r\n        this._updateInfo(INFO_TYPE.POPUP, prevProps.popup, nextProps.popup);\r\n      }\r\n    }\r\n\r\n    return this._layer;\r\n  }\r\n\r\n  /*\r\n   * Creates/updates spot DOM.\r\n   *\r\n   * @param {Object}  item    The icon props, which is retrieved from spot props.\r\n   *\r\n   */\r\n  _setSign(item) {\r\n    const { content, className: labelClass } = this._label;\r\n    const rotation = _.get(item, 'rotation', 0);\r\n\r\n    const spot = {\r\n      ...this._icon,\r\n      ..._.omit(item, ['rotation', 'spotOpacity']),\r\n      width: _.get(item, 'width', '15px'),\r\n      height: _.get(item, 'height', '15px'),\r\n      opacity: _.get(item, 'spotOpacity', 1)\r\n    };\r\n\r\n    const p = {\r\n      ..._.omit(spot, ['html', 'className', '_truncateLabels', 'iconAnchor', 'iconSize', 'id', 'isOngoingNode', 'renderCount']),\r\n      transform: `rotate(${rotation}deg)`\r\n    };\r\n\r\n    const camelCaseToDash = str => str.replace(/([a-zA-Z])(?=[A-Z])/g, '$1-').toLowerCase();\r\n\r\n    let styleString = '';\r\n    Object.keys(p).forEach((key) => {\r\n      if (Object.prototype.hasOwnProperty.call(p, key)) {\r\n        styleString += `${camelCaseToDash(key)}:${p[key]};`;\r\n      }\r\n    });\r\n    // Try not to use external library\r\n    // _.forOwn(p, (val, key) => { str += key + ':' + val + ';' })\r\n\r\n    if (!_.has(spot, 'renderCount')) {\r\n      spot.html = `<div class=\"gis-spot\" style=\"${styleString}\"></div><span class=\"${cx('gis-label', labelClass)}\">${content}</span>`;\r\n    } else {\r\n      spot.html = `<div class=\"gis-spot center-text\" style=\"${styleString}\"><span class=\"${cx('gis-label', labelClass)}\">${content}</span></div>`;\r\n    }\r\n    spot.iconAnchor = _.get(item, 'iconAnchor', [parseInt(spot.width, 10) / 2, parseInt(spot.height, 10) / 2]);\r\n    spot.height = 'auto';\r\n    spot.iconSize = _.get(item, 'iconSize', [parseInt(spot.width, 10), parseInt(spot.height, 10)]);\r\n\r\n    this._icon = spot;\r\n  }\r\n}\r\n\r\nexport default Spot;\r\n"],"file":"spot.js"}